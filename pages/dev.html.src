<title>enclone developers guide</title>

<body>

<br>
<img src="../../img/enclone_banner.png" alt="enclone banner" title="enclone banner" width=100% />

<! –– ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ -->

<p>This is a guide for #enclone developers, both inside and outside 10x Genomics.</p>

<p>There is no reason to read this, unless you want to experimentally modify #enclone, or are 
curious.  We distribute pre-built binaries for #enclone, and that's all you need if you just
want to run the existing code.
</p>

<h1>The #enclone components</h1>

<p>#enclone has the following software and data components:
<ul>

<li>
A GitHub repo
<a https://github.com/10XGenomics/enclone>https://github.com/10XGenomics/enclone</a>
that is maintained by 10x Genomics.  Contributions are welcome.  The software is licensed freely, 
however only for use with 10x Genomics data.  Please read the 
<a href="../../LICENSE.txt">license</a>.
</li>

<li>
A web site <a https://10xgenomics.github.io/enclone>https://10xgenomics.github.io/enclone</a>
that is built automatically by code in the above repo.
</li>

<li>
A separate GitHub repo
<a https://github.com/10XGenomics/enclone-data>https://10xgenomics.github.io/enclone-data</a>
that contains a small number of datasets.  If you build #enclone, this is automatically
downloaded as part of the build process.  If you install #enclone, this is downloaded, unless you 
choose the <code>small</code> option, in which case you get only a subset of it.
</li>

<li>
A larger collection of datasets that are downloaded if you install with the <code>large</code>
option.
</li>

<li>
A still larger collection of datasets that are internal to 10x Genomics and not publicly
available.  These datasets are kept internal because of consent restrictions, or because the
datasets were generated as part of experiments using unpublished protocols.  Some of these
datasets are used in the #enclone test suite, although there is a shorter test suite that runs
using only public data.  Developers at 10x Genomics can find the full collection in a directory 
<code>/mnt/assembly/vdj/current*</code>, where <code>*</code> is a version number.  There is also
a link <code>/mnt/assembly/cloud</code> that points to a copy on solid-state disk.  The full
dataset is not backed up, however there is a catalog 
<code>enclone/src/enclone.testlist.all</code> that would facilitate reconstruction in the
event of loss.  Over time, we gradually enlarge the collection.
</li>

</ul>
</p>

<! –– ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ -->

<h1>Software architecture</h1>

<p>#enclone is written in rust.</p>

<p>We used rust because the language makes it extremely easy to use rust code written by
other people, because rust has its own build system, and because it is fast and safe.</p>

<p>Technical details.  The repo is itself a rust workspace, with a half dozen or so
subdirectories that comprise rust crates.  Each of these crates has its own 
<code>Cargo.toml</code> file.  Modification of dependency
versions in these files files is done by modifying a file <code>master.toml</code> at the
top level,
and then typing <code>sync_to_master</code>, which invokes a program (part of the repo) to
sync each <code>Cargo.toml</code> to <code>master.toml</code>.
</p>

<! –– ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ -->

<h1>Prerequisites</h1>

<p>#enclone can be built and run on an x86-64 Linux server or a Mac, although we have not
tested on a Mac with an M1 processor.</p>

<p>The following software are needed to build and test #enclone:

<ul>

<li>rust.  Detailed instructions on how to install rust
can be found <a href="https://www.rust-lang.org/tools/install" rel="nofollow">here</a>. You can 
confirm that you have successfully installed the Rust compiler by running 
<code>rustc --version</code>.</p></li>

<li>cargo-license.  Probably this is needed only for internal use.  You can install it using
<code>cargo install cargo-license</code>, assuming that you have already installed rust.</li>

<li>standard utilities, including git, curl and wget.</li>

</ul>

<! –– ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ -->

<h1>Building #enclone</h1>

<ol>

<li>Follow the installation instructions on the main page to install #enclone, using the
medium or large options.  This is not needed for developers at 10x Genomics.
Doing this download data, which you will want for experimentation and testing.</li>

<li>
Go to a directory where you want to put the #enclone code, and
<p>clone the <code>enclone</code> repository using
<pre><code>git clone git@github.com:10XGenomics/enclone.git</code></pre>
If you have a very slow internet connection, you might wish to download only the current version
(and not the history) using
<pre><code>git clone --depth=1 git@github.com:10XGenomics/enclone.git</code></pre>.
</li>

<li>Type <code>cd enclone</code> and then <code>./build</code>.  Depending on your computer,
this will take roughly 5-10 minutes.  Subsequent invocations (after code changes) will be much 
faster.  For subsequent use, typing <code>cargo b</code> is even faster, but does omit some 
build steps (which may or may not matter, depending on what you're doing).</li>

<li>Add the full path of <code>enclone/target/debug</code> to your <code>PATH</code>, and 
make sure this comes <i>before</i> <code>~/bin</code>, which was where the precompiled
version of #enclone was downloaded to by the install command.  You may need to close and reopen
your terminal window to get the change to <code>PATH</code> to take effect.</li>

<li>Now when you type #enclone, you'll get the version you just compiled.</li>

</ol>

<p>If you have problems, please write to us at 
<a href="mailto:enclone@10xgenomics.com">#enclone@10xgenomics.com</a>.</p>

<! –– ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ -->

<h1>Testing #enclone</h1>

<p>#enclone has an extensive test suite. It has hundreds of tests.  Most but not all of the
tests can be run by anyone; the remainder use datasets that are internal to 10x Genomics.
(See earlier explanation.)</p>

<p>
To run the main tests, type:
<ul>
<li>[external users] <code>cd enclone_main; cargo tb</code></li>
<li>[internal users] <code>./test</code></li>
</ul>
</p>

<p>
There is also a very large test, which can only be run internally, which one runs by
<code>./enclone/enclone.test</code>.
</p>

<p>To better understand the testing machinery, please refer to the following files:
<ul>
<li> <code>enclone_core/src/testlist.rs</code></li>
<li> <code>enclone_main/tests/enclone_test*.rs</code></li>
<li> <code>test</code></li>
<li> <code>.cargo/config</code></li>
<li> <code>enclone/enclone.test</code>.</li>
</ul>

<! –– ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ -->

<h1>Profiling #enclone</h1>

<p>#enclone provides a few built-in mechanisms for profiling:</p>
<ol>

<li>Add the argument <code>COMP</code> to your command.  This yields a summary of wall-clock
time by code section, and also tracks peak memory usage.  There is also a version
<code>COMP2</code> that prints a bit more.  Run this with <code>NOPAGER</code> if you want
to see the lines printed as they happen.</li>

<li>Add the argument <code>PROFILE</code> to your command.  This yields a list of tracebacks
based on random interrupts.  These tracebacks are manicured and each is shown with its
multiplicity.  When this option is used, the internal paging mechanism in #enclone is turned
off, and you may wish to pipe the output to <code>less -r</code>.</li>

<li>Add the argument <code>CTRLC</code> to your command.  Then upon CTRL-C, execution will
be stopped and a traceback printed.  In general this is only useful if your code seems to
be extremely slow or perhaps is stuck in an infinite loop.</li>

</ol>
<p>It is usually convenient to add the argument <code>NOPRINT</code> when using these profiling
options, so as to suppress other output.</p>

</body>
</html>
